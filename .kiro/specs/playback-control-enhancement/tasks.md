# 实施计划

- [x] 1. 重构播放状态管理系统

  - 创建新的 `src/hooks/usePlaybackState.ts` 文件
  - 实现 PlaybackStateManager 类，支持播放、暂停、跳转、速度控制
  - 添加播放历史记录和撤销/重做功能
  - 集成播放模式与预览模式的状态区分逻辑
  - _需求: 1.1, 1.4, 2.1.1, 2.1.3, 5.1, 5.2_

- [x] 2. 实现交互式时间轴控制器

  - [x] 2.1 创建 TimelineControl 组件基础结构

    - 创建 `src/components/TimelineControl.tsx` 文件
    - 实现可拖拽的进度条 UI 组件
    - 添加关键帧标记和视觉指示器
    - 实现鼠标悬停和拖拽事件处理
    - _需求: 1.1, 1.2, 1.3_

  - [x] 2.2 实现精确的时间计算逻辑
    - 创建 `src/lib/timelineCalculator.ts` 文件
    - 实现时间与消息索引的双向转换算法
    - 添加关键帧自动检测和标记功能
    - 实现像素级精确的进度计算
    - _需求: 1.2, 1.3, 9.1, 9.2_

- [x] 3. 实现实时预览系统

  - [x] 3.1 创建预览渲染器

    - 创建 `src/lib/previewRenderer.ts` 文件
    - 实现聊天状态快照生成功能
    - 添加预览缩略图渲染逻辑
    - 实现离屏 Canvas 优化渲染性能
    - _需求: 2.1, 2.2, 2.3, 2.5_

  - [x] 3.2 创建预览提示组件
    - 创建 `src/components/PreviewTooltip.tsx` 文件
    - 实现悬停时的预览缩略图显示
    - 添加预览信息面板（时间、消息索引等）
    - 实现预览提示的位置自适应逻辑
    - _需求: 2.1, 2.4_

- [x] 4. 重构播放控制面板

  - [x] 4.1 增强 PlaybackControls 组件

    - 更新 `src/components/PlaybackControls.tsx` 文件
    - 集成新的时间轴控制器组件
    - 添加播放模式切换按钮（普通/循环/预览）
    - 实现精确速度控制（0.1x-5x 连续调节）
    - _需求: 3.1, 3.2, 3.3, 5.2_

  - [x] 4.2 添加键盘快捷键支持
    - 在 PlaybackControls 中添加键盘事件监听
    - 实现空格键播放/暂停、左右箭头跳转消息
    - 添加数字键快速设置播放速度
    - 实现快捷键提示和帮助面板
    - _需求: 1.5, 7.2_

- [x] 5. 实现播放模式与预览模式区分

  - [x] 5.1 修改 ChatInterface 组件

    - 更新 `src/components/ChatInterface.tsx` 文件
    - 实现播放模式下的逐条消息显示逻辑
    - 添加自动滚动功能，确保最新消息可见
    - 实现预览模式下的完整消息列表显示
    - _需求: 2.1.1, 2.1.2, 2.1.4, 2.1.5_

  - [x] 5.2 实现智能滚动控制
    - 创建 `src/hooks/useAutoScroll.ts` 文件
    - 实现平滑的自动滚动动画
    - 添加滚动位置的精确计算和控制
    - 实现滚动状态与播放状态的同步
    - _需求: 2.1.2, 2.1.4_

- [x] 6. 重构导出引擎

  - [x] 6.1 创建新的导出引擎

    - 创建 `src/lib/exportEngine.ts` 文件
    - 实现多格式导出支持（GIF、MP4、WebM）
    - 添加质量预设和自定义配置选项
    - 使用 Web Worker 进行后台导出处理
    - _需求: 4.1, 4.2, 4.4_

  - [x] 6.2 创建导出 Web Worker
    - 创建 `public/workers/export-worker.js` 文件
    - 实现帧捕获和编码逻辑
    - 添加导出进度计算和报告功能
    - 实现内存管理和错误处理
    - _需求: 4.3, 6.4_

- [x] 7. 实现导出配置管理

  - [x] 7.1 创建导出配置对话框

    - 创建 `src/components/ExportDialog.tsx` 文件
    - 实现导出格式、质量、分辨率等配置选项
    - 添加导出预设的保存和加载功能
    - 实现导出进度显示和取消功能
    - _需求: 4.2, 4.3, 8.1, 8.2_

  - [x] 7.2 实现导出历史管理
    - 创建 `src/hooks/useExportHistory.ts` 文件
    - 实现导出历史记录的保存和查看
    - 添加重新导出和配置复用功能
    - 实现导出文件的本地缓存管理
    - _需求: 8.4_

- [ ] 8. 实现性能优化

  - [ ] 8.1 创建虚拟化消息列表

    - 创建 `src/components/VirtualizedMessageList.tsx` 文件
    - 实现消息列表的虚拟滚动功能
    - 添加可见范围计算和动态渲染逻辑
    - 优化大量消息时的渲染性能
    - _需求: 6.1, 6.3_

  - [ ] 8.2 实现防抖和节流优化
    - 创建 `src/utils/performanceUtils.ts` 文件
    - 实现拖拽操作的防抖处理
    - 添加预览生成的节流控制
    - 实现渲染帧率的自适应调节
    - _需求: 6.2, 6.5_

- [ ] 9. 实现时间轴可视化增强

  - [ ] 9.1 创建时间轴标记系统

    - 创建 `src/components/TimelineMarkers.tsx` 文件
    - 实现不同消息类型的可视化标记
    - 添加时间轴缩放和导航功能
    - 实现标记点的交互和信息显示
    - _需求: 9.1, 9.2, 9.3_

  - [ ] 9.2 实现时间轴编辑功能
    - 在 TimelineControl 中添加编辑模式
    - 实现拖拽调整消息时长和位置
    - 添加时间轴的导出和分享功能
    - 实现时间轴配置的保存和加载
    - _需求: 9.4, 9.5_

- [ ] 10. 实现错误处理和恢复机制

  - [ ] 10.1 创建错误管理系统

    - 创建 `src/lib/errorManager.ts` 文件
    - 实现播放错误的捕获和分类
    - 添加错误恢复策略和降级方案
    - 实现用户友好的错误提示和解决建议
    - _需求: 7.4_

  - [ ] 10.2 实现性能监控
    - 创建 `src/hooks/usePerformanceMonitor.ts` 文件
    - 实现实时 FPS 和内存使用监控
    - 添加性能警告和自动优化建议
    - 实现性能数据的收集和分析
    - _需求: 6.5_

- [ ] 11. 集成所有组件到主应用

  - [ ] 11.1 更新主应用组件

    - 更新 `src/App.tsx` 文件
    - 集成新的播放状态管理系统
    - 替换旧的播放控制组件
    - 确保所有新功能正确协作
    - _需求: 所有需求集成_

  - [ ] 11.2 实现状态持久化
    - 创建 `src/hooks/useStatePersistence.ts` 文件
    - 实现播放状态的本地存储和恢复
    - 添加用户偏好设置的保存功能
    - 实现会话恢复和断点续播
    - _需求: 5.5_

- [ ] 12. 实现用户体验增强

  - [ ] 12.1 添加加载状态和过渡动画

    - 在各个组件中添加加载状态指示器
    - 实现组件间的平滑过渡动画
    - 添加操作反馈和确认提示
    - 优化界面响应速度和视觉反馈
    - _需求: 7.1, 7.2_

  - [ ] 12.2 实现主题和自定义选项
    - 创建 `src/hooks/useThemeCustomization.ts` 文件
    - 实现深色模式和自定义主题支持
    - 添加界面布局和控件大小调节
    - 实现用户界面偏好的保存和同步
    - _需求: 7.5_

- [ ] 13. 实现协作功能基础

  - [ ] 13.1 创建状态同步机制

    - 创建 `src/lib/collaborationSync.ts` 文件
    - 实现播放状态的实时同步协议
    - 添加多用户播放位置的显示
    - 实现协作会话的创建和加入功能
    - _需求: 10.1, 10.2_

  - [ ] 13.2 实现协作标注系统
    - 创建 `src/components/CollaborationAnnotations.tsx` 文件
    - 实现时间轴上的评论和标注功能
    - 添加协作者的实时光标显示
    - 实现标注的保存、编辑和删除功能
    - _需求: 10.3_

- [ ] 14. 编写测试用例

  - [ ] 14.1 创建单元测试

    - 为 PlaybackStateManager 编写完整的单元测试
    - 测试 TimelineControl 的拖拽和交互功能
    - 验证 PreviewRenderer 的快照生成准确性
    - 测试 ExportEngine 的多格式导出功能
    - _需求: 测试覆盖_

  - [ ] 14.2 创建集成测试
    - 测试播放控制与聊天界面的同步
    - 验证导出功能的端到端流程
    - 测试性能优化的实际效果
    - 验证错误处理和恢复机制
    - _需求: 质量保证_

- [ ] 15. 性能测试和优化

  - [ ] 15.1 进行性能基准测试

    - 测试不同消息数量下的渲染性能
    - 验证拖拽操作的响应时间
    - 测试导出功能的速度和质量
    - 分析内存使用和泄漏情况
    - _需求: 6.2, 6.3, 6.4_

  - [ ] 15.2 实施性能优化措施
    - 根据测试结果优化关键性能瓶颈
    - 实现自适应质量调节机制
    - 添加性能监控和警告系统
    - 优化资源加载和缓存策略
    - _需求: 6.1, 6.5_

- [ ] 16. 创建示例和文档

  - [ ] 16.1 创建功能演示示例

    - 创建展示新播放控制功能的示例配置
    - 添加复杂时间轴操作的演示案例
    - 创建导出功能的使用指南示例
    - 制作性能优化效果的对比演示
    - _需求: 用户指导_

  - [ ] 16.2 更新用户文档
    - 更新 README 文档，添加新功能说明
    - 创建播放控制功能的详细使用指南
    - 添加导出配置和优化建议文档
    - 创建故障排除和性能优化指南
    - _需求: 文档完善_
